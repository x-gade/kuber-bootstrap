# Cilium & BPF Setup Scripts

Этот документ описывает назначение и работу скриптов, используемых для настройки Cilium, BPF и сетевой инфраструктуры Kubernetes в рамках системы автоматической инициализации кластера.

---

## `network_patch.py`

**Назначение:**
Патчит конфигурацию Cilium после установки, включая добавление опции `custom-cni-conf=true` в `ConfigMap` Cilium, что позволяет использовать собственную CNI-конфигурацию вместо автогенерируемой.

**Основные действия:**

* Ожидает доступности ресурса `ConfigMap/cilium-config`.
* Вносит правку ключа `custom-cni-conf`.
* Применяет изменения с помощью `kubectl patch`.

---

## `verify_bpf_mount.py`

**Назначение:**
Проверяет корректность маунта `bpffs` в `/sys/fs/bpf`, что необходимо для работы eBPF в Kubernetes-сетях с Cilium.

**Основные действия:**

* Проверяет наличие `/sys/fs/bpf`.
* Использует `mount` или `findmnt` для проверки типа маунта.
* Завершает работу с ошибкой, если BPF не смонтирован корректно.

---

## `install_bpf_files.py`

**Назначение:**
Устанавливает необходимые eBPF-файлы, обеспечивающие функциональность Cilium, в системные директории.

**Основные действия:**

* Создаёт каталоги `/sys/fs/bpf`, `/run/cilium`, `/var/lib/cilium` (если отсутствуют).
* Назначает нужные права и владельцев.

---

## `install_cilium_cni.py`

**Назначение:**
Устанавливает бинарник `cilium-cni` в каталог CNI плагинов (`/opt/cni/bin/`) и создаёт конфигурацию `10-cilium.conflist`.

**Основные действия:**

* Распаковывает архив с `cilium-cni`.
* Копирует бинарник в `/opt/cni/bin/`.
* Генерирует конфигурацию CNI (`conflist`).

---

## `generate_cilium_sa.py`

**Назначение:**
Создаёт ServiceAccount и ClusterRoleBinding для Cilium.

**Основные действия:**

* Применяет YAML-манифест с `kubectl apply`.
* Убеждается, что SA и RBAC применены до установки Cilium.

---

## `apply_crds_cilium.py`

**Назначение:**
Применяет CustomResourceDefinition (CRD) для Cilium.

**Основные действия:**

* Загружает и применяет CRD-манифесты.
* Требуется до запуска любых компонентов Cilium.

---

## `generate_cilium_values.py`

**Назначение:**
Генерирует файл `values.yaml` с параметрами Helm для установки Cilium в соответствии с архитектурой пользователя.

**Основные действия:**

* Использует данные из `collected_info`.
* Создаёт кастомный `values.yaml` с параметрами (например, `ipv4.enabled`, `kubeProxyReplacement`, `hostFirewall` и др).

---

## `join_nodes.py`

**Назначение:**
Добавляет worker-ноды в Kubernetes кластер, используя параметры из файла `data/join_info.json`.

**Основные действия:**

* Выполняет `kubeadm join` с параметрами токена и discovery hash.
* Поддерживает разные роли нод.

---

## `label_node.py`

**Назначение:**
Устанавливает метку роли (label) Kubernetes-ноде (`node-role.kubernetes.io/<role>`), чтобы позволить планирование подов в зависимости от роли.

**Основные действия:**

* Ожидает появления ноды через `kubectl get node`.
* Устанавливает или обновляет метку роли.

---

## `initialize_coredns.py`

**Назначение:**
Перезапускает или инициализирует CoreDNS, если он не работает, после установки сетевого плагина (например, Cilium).

**Основные действия:**

* Проверяет статус подов `coredns`.
* Применяет перезапуск или обновление через `kubectl rollout`.

---
