
# ‚öôÔ∏è Kuber Bootstrap

–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Kubernetes control-plane –∏ worker —É–∑–ª–æ–≤ **–±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è embedded etcd**, —Å –ø–æ–ª–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤, systemd-—é–Ω–∏—Ç–æ–≤ –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–æ–π —á–µ—Ä–µ–∑ `main.py`.

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
/kuber-bootstrap
‚îÇ
‚îú‚îÄ‚îÄ cluster/                            # –°–∫—Ä–∏–ø—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∫–ª–∞—Å—Ç–µ—Ä–∞
‚îÇ   ‚îú‚îÄ‚îÄ sync_cluster_state.py           # –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, –ø–∏–Ω–≥ –∏ —É—á—ë—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —É–∑–ª–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ rotate_cluster_certs.py         # –†–æ—Ç–∞—Ü–∏—è –≤—Å–µ—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –≤–æ –≤—Å–µ—Ö –Ω–æ–¥–∞—Ö
‚îÇ   ‚îî‚îÄ‚îÄ force_cluster_restart.py        # –†—É—á–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–ª—é—á–µ–≤—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
‚îÇ
‚îú‚îÄ‚îÄ setup/
‚îÇ   ‚îú‚îÄ‚îÄ install_dependencies.py         # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –Ω—É–∂–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ check_binaries.py               # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è etcd, kubeadm –∏ –ø—Ä.
‚îÇ   ‚îî‚îÄ‚îÄ install_binaries.py             # –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –±–∏–Ω–∞—Ä–Ω–∏–∫–æ–≤ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏
‚îÇ
‚îú‚îÄ‚îÄ certs/
‚îÇ   ‚îú‚îÄ‚îÄ generate_all.py                 # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤—Å–µ—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ —Å –ª–æ–≥–∞–º–∏
‚îÇ   ‚îú‚îÄ‚îÄ renew_certs.py                  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
‚îÇ   ‚îî‚îÄ‚îÄ cert_info.json                  # –§–∞–π–ª –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (–Ω–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ git)
‚îÇ
‚îú‚îÄ‚îÄ systemd/
‚îÇ   ‚îú‚îÄ‚îÄ generate_etcd_service.py        # –Æ–Ω–∏—Ç –∏ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ etcd
‚îÇ   ‚îî‚îÄ‚îÄ generate_apiserver_service.py   # (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –∑–∞–ø—É—Å–∫ kube-apiserver –∫–∞–∫ systemd unit
‚îÇ
‚îú‚îÄ‚îÄ kubeadm/
‚îÇ   ‚îú‚îÄ‚îÄ create_certificates.py          # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è TLS –¥–ª—è kubeadm
‚îÇ   ‚îú‚îÄ‚îÄ generate_kubeadm_config.py      # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è kubeadm-config.yaml
‚îÇ   ‚îî‚îÄ‚îÄ run_kubeadm_init.py             # –ó–∞–ø—É—Å–∫ kubeadm init –±–µ–∑ etcd
‚îÇ
‚îú‚îÄ‚îÄ post/
‚îÇ   ‚îú‚îÄ‚îÄ apply_cni.py                    # –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–µ—Ç–µ–≤–æ–≥–æ –ø–ª–∞–≥–∏–Ω–∞ (Flannel/Cilium)
‚îÇ   ‚îú‚îÄ‚îÄ patch_controller_flags.py       # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–ª–∞–≥–∏ –¥–ª—è controller-manager/scheduler
‚îÇ   ‚îî‚îÄ‚îÄ join_nodes.py                   # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è `kubeadm join` –∏–ª–∏ join-config.yaml
‚îÇ
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îú‚îÄ‚îÄ logger.py                       # –¶–≤–µ—Ç–Ω–æ–π –ª–æ–≥–≥–µ—Ä
‚îÇ   ‚îú‚îÄ‚îÄ shell.py                        # –û–±—ë—Ä—Ç–∫–∞ –¥–ª—è subprocess
‚îÇ   ‚îú‚îÄ‚îÄ cert_helpers.py                 # –ü—Ä–æ–≤–µ—Ä–∫–∞/–≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
‚îÇ   ‚îî‚îÄ‚îÄ validator.py                    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —à–∞–≥–æ–≤
‚îÇ
‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îú‚îÄ‚îÄ required_binaries.yaml          # –ß—Ç–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
‚îÇ   ‚îú‚îÄ‚îÄ missing_binaries.json           # –ß—Ç–æ –Ω—É–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è)
‚îÇ   ‚îî‚îÄ‚îÄ collected_info.json             # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∞—à–∏–Ω–µ (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è)
‚îÇ
‚îú‚îÄ‚îÄ logs/
‚îÇ   ‚îî‚îÄ‚îÄ bootstrap.log                   # –ì–ª–∞–≤–Ω—ã–π –ª–æ–≥ –≤—Å–µ—Ö —à–∞–≥–æ–≤
‚îÇ
‚îú‚îÄ‚îÄ collect_node_info.py                # –°–±–æ—Ä IP, CIDR, –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –∏ —Ä–æ–ª–∏ —É–∑–ª–∞
‚îî‚îÄ‚îÄ main.py                             # –ì–ª–∞–≤–Ω—ã–π –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)
```

## üöÄ –ü–æ—Ç–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

1. `collect_node_info.py` ‚Äî –°–±–æ—Ä —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏: IP, CIDR, —Ä–æ–ª—å, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞, –û–°.
2. `check_binaries.py` ‚Äî –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω—É–∂–Ω—ã—Ö –±–∏–Ω–∞—Ä–Ω–∏–∫–æ–≤: kubeadm, etcd, containerd –∏ –¥—Ä.
3. `install_dependencies.py` ‚Äî –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤.
4. `generate_all.py` ‚Äî –ì–µ–Ω–µ—Ä–∞—Ü–∏—è CA –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ etcd, API, proxy.
5. `generate_etcd_service.py` ‚Äî –ì–µ–Ω–µ—Ä–∞—Ü–∏—è systemd unit –∏ –∑–∞–ø—É—Å–∫ etcd.
6. `generate_kubeadm_config.py` ‚Äî –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ kubeadm.
7. `run_kubeadm_init.py` ‚Äî –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Kubernetes –±–µ–∑ embedded etcd.
8. `generate_apiserver_service.py` ‚Äî (–æ–ø—Ü.) –ó–∞–ø—É—Å–∫ apiserver –∫–∞–∫ systemd unit.
9. `apply_cni.py` ‚Äî –£—Å—Ç–∞–Ω–æ–≤–∫–∞ CNI (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é Flannel –∏–ª–∏ Cilium).
10. `patch_controller_flags.py` ‚Äî –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω—É–∂–Ω—ã—Ö —Ñ–ª–∞–≥–æ–≤ –≤ kube-controller.
11. `join_nodes.py` ‚Äî –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ worker-–Ω–æ–¥—ã.
12. `renew_certs.py` ‚Äî –ü–ª–∞–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤.
13. `sync_cluster_state.py` ‚Äî –£—á—ë—Ç –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É–∑–ª–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ.
14. `rotate_cluster_certs.py` ‚Äî –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Ä–æ—Ç–∞—Ü–∏—è certs (WIP).

## ‚öôÔ∏è .gitignore (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)

–ù–µ –¥–æ–±–∞–≤–ª—è—Ç—å –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:
- `certs/cert_info.json`
- `data/collected_info.json`
- `data/missing_binaries.json`
- `__pycache__/`
- `logs/`

## üì¶ –ü—Ä–∏–º–µ—Ä –∑–∞–ø—É—Å–∫–∞

```bash
python3 collect_node_info.py control-plane
python3 setup/check_binaries.py
python3 setup/install_dependencies.py
python3 certs/generate_all.py
python3 systemd/generate_etcd_service.py
python3 kubeadm/generate_kubeadm_config.py
python3 kubeadm/run_kubeadm_init.py
```

–ò–ª–∏ –≤ –±—É–¥—É—â–µ–º:
```bash
python3 main.py --role control-plane
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –í—Å–µ –∫–ª—é—á–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è —Å `2048` –∏–ª–∏ `4096` –±–∏—Ç.
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `openssl` (–≤–æ–∑–º–æ–∂–Ω–æ –≤ –±—É–¥—É—â–µ–º cfssl).
- –í–µ–¥—ë—Ç—Å—è –∂—É—Ä–Ω–∞–ª –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (`logs/bootstrap.log`).

## üìç –ü–ª–∞–Ω—ã:
- [ ] –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ worker-–Ω–æ–¥.
- [ ] –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π `main.py` —Å resume-—Ñ–ª–∞–≥–∞–º–∏.
- [ ] –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —É–¥–∞–ª—ë–Ω–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è (—á–µ—Ä–µ–∑ ssh).
- [ ] Helm-—á–∞—Ä—Ç—ã –¥–ª—è –º–æ–¥—É–ª—å–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤.

---

–†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ —Å ‚ù§Ô∏è –¥–ª—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã, –∫–æ—Ç–æ—Ä–∞—è **–∑–∞—Å–ª—É–∂–∏–≤–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏**.
